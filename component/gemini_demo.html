<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ant Design é£æ ¼éŸ³ä¹æ’­æ”¾å™¨ (çº¯ CSS)</title>
    <!-- å¼•å…¥ Lucide Icons ç”¨äºæ§åˆ¶æŒ‰é’® -->
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        /* ==================================== */
        /* 1. å…¨å±€é…ç½®ä¸ Ant Design å˜é‡ */
        /* ==================================== */
        :root {
            --primary-color: #1677ff; /* Ant Design Blue */
            --primary-hover: #4096ff;
            --border-color: #d9d9d9;
            --bg-light: #f5f5f5; /* ç±»ä¼¼ AntD çš„èƒŒæ™¯è‰² */
            --bg-card: #ffffff;
            --text-dark: #333;
            --text-light: #666;
            --radius: 8px;
            --shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03), 0 1px 3px 1px rgba(0, 0, 0, 0.02);
            --shadow-lg: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji';
            background-color: var(--bg-light);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }

        /* ==================================== */
        /* 2. æ’­æ”¾å™¨ä¸»å®¹å™¨ (å·²ä¼˜åŒ–ï¼šæ–°å¢ min-width) */
        /* ==================================== */
        .player-card {
            width: 100%;
            max-width: 1200px;
            /* ç¡®ä¿åœ¨æ‰‹æœºä¸Šå†…å®¹ä¸ä¼šè¢«è¿‡åº¦å‹ç¼© */
            min-width: 360px; 
            background-color: var(--bg-card);
            box-shadow: var(--shadow-lg);
            border-radius: var(--radius);
            padding: 32px;
        }

        .player-header {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-dark);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 16px;
            margin-bottom: 24px;
        }

        /* ==================================== */
        /* 3. æ ¸å¿ƒå¸ƒå±€ (å“åº”å¼) */
        /* ==================================== */
        .player-core {
            display: flex;
            flex-direction: column;
            gap: 32px;
        }

        @media (min-width: 1024px) {
            .player-core {
                flex-direction: row;
            }
            .player-section {
                width: 50%;
            }
        }

        /* ==================================== */
        /* 4. ä¸“è¾‘å°é¢ä¸æ­Œè¯åŒºåŸŸ */
        /* ==================================== */
        .album-art-wrapper {
            background-color: #e6f7ff; /* light blue background */
            aspect-ratio: 1 / 1;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px;
        }
        .album-art {
            width: 100%;
            height: 100%;
            background-size: cover;
            background-position: center;
            border-radius: var(--radius);
        }

        .lyrics-container {
            background-color: #f6f6f6;
            padding: 16px;
            border-radius: var(--radius);
            height: 256px;
            overflow-y: scroll;
            border: 1px solid var(--border-color);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06);
        }

        .lyrics-header {
            font-size: 14px;
            color: var(--text-light);
            margin-bottom: 8px;
        }

        .lyrics-display {
            text-align: center;
            color: var(--text-light);
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .current-lyric {
            color: var(--primary-color);
            font-weight: 600;
            transform: scale(1.05);
            transition: all 0.2s ease-in-out;
            font-size: 18px;
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡ç¾åŒ– */
        .lyrics-container::-webkit-scrollbar,
        .playlist-container::-webkit-scrollbar {
            width: 6px;
        }
        .lyrics-container::-webkit-scrollbar-thumb,
        .playlist-container::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 10px;
        }
        .lyrics-container::-webkit-scrollbar-thumb:hover,
        .playlist-container::-webkit-scrollbar-thumb:hover {
            background-color: #a8a8a8;
        }

        /* ==================================== */
        /* 5. æ’­æ”¾åˆ—è¡¨åŒºåŸŸ */
        /* ==================================== */
        .playlist-header {
            font-size: 20px;
            font-weight: 500;
            color: var(--text-dark);
            margin-bottom: 16px;
        }

        .playlist-container {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            height: 384px;
            overflow-y: scroll;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06);
            border-top: none; /* AntD åˆ—è¡¨é€šå¸¸æ²¡æœ‰é¡¶éƒ¨åˆ†éš”çº¿ */
        }
        
        .track-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px;
            cursor: pointer;
            transition: background-color 0.15s, box-shadow 0.15s;
            border-bottom: 1px solid #f0f0f0; /* åˆ—è¡¨åˆ†å‰²çº¿ */
        }

        .track-item:last-child {
            border-bottom: none;
        }

        .track-item:hover {
            background-color: var(--primary-color, #1677ff)10; /* Primary color with 10% opacity */
        }
        
        .track-info-main {
            display: flex;
            align-items: center;
            gap: 12px;
            overflow: hidden;
        }

        .track-index {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            width: 24px;
            text-align: center;
        }

        .track-titles {
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .track-title {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-dark);
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .track-artist {
            font-size: 12px;
            color: var(--text-light);
            overflow: hidden;
            white-space: nowrap;
            text-overflow: ellipsis;
        }
        .track-duration {
            font-size: 12px;
            color: #ccc;
            flex-shrink: 0;
            margin-left: 8px;
        }

        /* æ’­æ”¾åˆ—è¡¨é«˜äº®çŠ¶æ€ */
        .track-item.is-playing {
            background-color: rgba(22, 119, 255, 0.1);
            box-shadow: inset 3px 0 0 var(--primary-color); /* å·¦ä¾§æŒ‡ç¤ºæ¡ */
        }
        .track-item.is-playing .track-title,
        .track-item.is-playing .track-artist {
            color: var(--primary-color);
        }

        /* ==================================== */
        /* 6. åº•éƒ¨æ§åˆ¶æ  */
        /* ==================================== */
        .control-bar {
            background-color: var(--bg-light);
            padding: 16px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            margin-top: 24px;
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.06);
        }
        
        .current-track-info {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .track-details {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            overflow: hidden;
        }
        .track-details-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-dark);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .track-details-artist {
            font-size: 14px;
            color: var(--text-light);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* è¿›åº¦æ¡æ ·å¼ */
        .progress-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .time-label {
            font-size: 12px;
            color: var(--text-light);
            width: 40px;
            text-align: right;
            flex-shrink: 0;
        }
        .time-label.right {
            text-align: left;
        }
        
        .progress-bar-input {
            flex-grow: 1;
            height: 4px;
            background-color: var(--border-color);
            border-radius: 2px;
            appearance: none;
            cursor: pointer;
            outline: none;
        }
        .progress-bar-input::-webkit-slider-thumb {
            appearance: none;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-color);
            transition: all 0.2s;
        }
        .progress-bar-input:hover::-webkit-slider-thumb {
            width: 14px;
            height: 14px;
            box-shadow: 0 0 0 4px rgba(22, 119, 255, 0.2);
        }

        /* æ’­æ”¾æ§åˆ¶ä¸éŸ³é‡ (å·²ä¼˜åŒ–ï¼šå…è®¸æ¢è¡Œ) */
        .controls-and-volume {
            display: flex;
            align-items: center;
            justify-content: space-between;
            /* å…è®¸åœ¨å°å±å¹•ä¸Šè‡ªåŠ¨æ¢è¡Œ */
            flex-wrap: wrap; 
        }
        
        @media (max-width: 480px) {
            /* ç¡®ä¿åœ¨éå¸¸å°çš„æ‰‹æœºå±å¹•ä¸Šï¼Œæ§åˆ¶ç»„å’ŒéŸ³é‡æ§åˆ¶èƒ½æ¢è¡Œå¯¹é½ */
            .controls-and-volume {
                justify-content: center; /* å±…ä¸­å¯¹é½ */
                gap: 16px; /* å¢åŠ æ¢è¡Œåçš„é—´è· */
            }
            .volume-control {
                 /* åœ¨çª„å±ä¸Šï¼ŒéŸ³é‡æ§åˆ¶å æ®å…¨éƒ¨å®½åº¦ */
                width: 100%; 
                justify-content: center;
            }
            .controls-group {
                width: 100%;
                justify-content: center;
            }
        }


        .controls-group {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .control-button {
            border: none;
            background: none;
            color: var(--text-light);
            padding: 8px;
            border-radius: 50%;
            cursor: pointer;
            transition: color 0.15s, background-color 0.15s;
        }
        .control-button:hover {
            color: var(--primary-color);
            background-color: rgba(22, 119, 255, 0.05);
        }
        
        .play-pause-button {
            background-color: var(--primary-color);
            color: white;
            padding: 16px;
            border-radius: 50%;
            box-shadow: 0 2px 8px rgba(22, 119, 255, 0.5);
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .play-pause-button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(22, 119, 255, 0.7);
            background-color: var(--primary-hover);
        }
        .play-pause-button svg {
            fill: white;
        }


        .volume-control {
            display: flex;
            align-items: center;
            gap: 8px;
            /* ç§»é™¤å›ºå®šçš„ 160px å®½åº¦ï¼Œè®©å®ƒéšå†…å®¹å˜åŒ– */
        }
        .volume-icon {
            color: var(--text-light);
        }
        
        .volume-bar-input {
            flex-grow: 1;
            height: 4px;
            background-color: var(--border-color);
            border-radius: 2px;
            appearance: none;
            cursor: pointer;
            outline: none;
        }
        .volume-bar-input::-webkit-slider-thumb {
            appearance: none;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            /* ä¿®å¤ï¼šæ·»åŠ å›é€€å€¼ #1677ff ä»¥ç¡®ä¿åœ¨ä¼ªå…ƒç´ ä¸­æ ·å¼èƒ½æ­£ç¡®åŠ è½½ */
            background: var(--primary-color, #1677ff);
        }
        .volume-bar-input:hover::-webkit-slider-thumb {
             box-shadow: 0 0 0 3px rgba(22, 119, 255, 0.2);
        }

        /* éšè—åŸç”Ÿçš„éŸ³é¢‘å…ƒç´  */
        #audio-player {
            display: none;
        }

        /* ========== Gemini Analysis Panel Styles ========== */
        .analysis-panel {
            position: fixed;
            bottom: 120px; /* æ”¾åœ¨æ§åˆ¶æ ä¸Šæ–¹ */
            right: 20px;
            width: 320px;
            max-height: 450px;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow-lg);
            z-index: 1000;
            display: none; 
            flex-direction: column;
        }

        .analysis-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            font-weight: 600;
            color: var(--primary-color);
            border-bottom: 1px solid var(--border-color);
        }

        .analysis-content {
            padding: 16px;
            overflow-y: auto;
            font-size: 14px;
            color: var(--text-dark);
            flex-grow: 1;
        }
        .analysis-content p {
            margin-bottom: 10px;
            line-height: 1.6;
        }

        .analysis-sources {
            font-size: 10px;
            padding: 8px 16px;
            border-top: 1px solid #f0f0f0;
            color: var(--text-light);
            line-height: 1.4;
        }
        .analysis-sources a {
            color: var(--primary-color);
            text-decoration: none;
            word-break: break-all;
        }
        .analysis-sources a:hover {
            text-decoration: underline;
        }

        /* Loading Spinner Style */
        .spinner {
            border: 4px solid rgba(22, 119, 255, 0.2);
            border-left-color: var(--primary-color);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- ä¸»éŸ³ä¹æ’­æ”¾å™¨å®¹å™¨ (Ant Design Card é£æ ¼) -->
    <div id="music-player-app" class="player-card">
        <h1 class="player-header">
            ğŸ§ éŸ³ä¹æ’­æ”¾å™¨ (çº¯ CSS AntD Style)
        </h1>

        <!-- æ’­æ”¾å™¨æ ¸å¿ƒåŒºåŸŸ -->
        <div class="player-core">
            
            <!-- å·¦ä¾§: ä¸“è¾‘å°é¢ä¸æ­Œè¯æ˜¾ç¤º -->
            <div class="player-section" style="display: flex; flex-direction: column; gap: 16px;">
                <!-- ä¸“è¾‘å°é¢ Placeholder -->
                <div class="album-art-wrapper">
                    <div class="album-art" style="background-image: url('https://placehold.co/500x500/1677ff/ffffff?text=Album+Art');">
                    </div>
                </div>

                <!-- æ­Œè¯æ˜¾ç¤ºåŒºåŸŸ -->
                <div class="lyrics-container">
                    <p class="lyrics-header">å½“å‰æ­Œè¯ï¼š</p>
                    <div id="lyrics-display" class="lyrics-display">
                        <!-- æ­Œè¯å°†åœ¨æ­¤å¤„åŠ¨æ€åŠ è½½ -->
                        <p>è¯·é€‰æ‹©æ­Œæ›²å¼€å§‹æ’­æ”¾...</p>
                    </div>
                </div>
            </div>

            <!-- å³ä¾§: æ’­æ”¾åˆ—è¡¨ -->
            <div class="player-section">
                <h2 class="playlist-header">æ’­æ”¾åˆ—è¡¨ (4 é¦–)</h2>
                <div id="playlist-container" class="playlist-container">
                    <!-- æ’­æ”¾åˆ—è¡¨é¡¹å°†åœ¨æ­¤å¤„åŠ¨æ€åŠ è½½ -->
                </div>
            </div>
        </div>
        
        <!-- åº•éƒ¨æ§åˆ¶æ  - å§‹ç»ˆæ˜¾ç¤º -->
        <div class="control-bar">
            <audio id="audio-player"></audio>
            
            <!-- æ­Œæ›²ä¿¡æ¯ å’Œ LLM æŒ‰é’® (æ–°åŠŸèƒ½) -->
            <div class="current-track-info">
                <div class="track-details">
                    <span id="current-title" class="track-details-title">æœªé€‰æ‹©æ­Œæ›²</span>
                    <span id="current-artist" class="track-details-artist">--</span>
                </div>
                <!-- æ–°å¢ï¼šæ­Œæ›²è§£ææŒ‰é’® -->
                <button id="analyze-btn" class="control-button text-xs font-semibold py-1 px-3 border" style="border-radius: 4px; border-color: var(--primary-color); color: var(--primary-color); transition: all 0.2s;">
                    <i data-lucide="sparkles" class="w-4 h-4 mr-1" style="display: inline-block; vertical-align: middle;"></i>
                    æ­Œæ›²è§£æ
                </button>
            </div>

            <!-- è¿›åº¦æ¡ -->
            <div class="progress-container">
                <span id="current-time" class="time-label">0:00</span>
                <input type="range" id="progress-bar" min="0" max="100" value="0" step="0.1" class="progress-bar-input" />
                <span id="total-time" class="time-label right">0:00</span>
            </div>

            <!-- æ’­æ”¾æ§åˆ¶ä¸éŸ³é‡ -->
            <div class="controls-and-volume">
                
                <!-- æ§åˆ¶æŒ‰é’®ç»„ -->
                <div class="controls-group">
                    <!-- ä¸Šä¸€é¦– -->
                    <button id="prev-btn" class="control-button">
                        <i data-lucide="skip-back" class="w-6 h-6"></i>
                    </button>
                    <!-- æ’­æ”¾/æš‚åœ -->
                    <button id="play-pause-btn" class="play-pause-button">
                        <i data-lucide="play" id="play-pause-icon" class="w-6 h-6"></i>
                    </button>
                    <!-- ä¸‹ä¸€é¦– -->
                    <button id="next-btn" class="control-button">
                        <i data-lucide="skip-forward" class="w-6 h-6"></i>
                    </button>
                </div>

                <!-- éŸ³é‡æ§åˆ¶ (å·²æ”¹è¿›) -->
                <div class="volume-control">
                    <!-- æ–°å¢ï¼šå°†éŸ³é‡å›¾æ ‡å˜ä¸ºå¯ç‚¹å‡»çš„é™éŸ³æŒ‰é’® -->
                    <button id="mute-btn" class="control-button" style="padding: 0;"> 
                        <i data-lucide="volume-2" id="volume-icon" class="volume-icon w-5 h-5"></i>
                    </button>
                    <input type="range" id="volume-bar" min="0" max="1" value="0.75" step="0.01" class="volume-bar-input" />
                    <span id="volume-percent" class="time-label right" style="width: auto;">75%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Gemini æ­Œæ›²è§£æé¢æ¿ (æ–°å¢) -->
    <div id="analysis-panel" class="analysis-panel">
        <div class="analysis-header">
            <span id="analysis-title">âœ¨ æ­Œæ›²èƒŒæ™¯ä¸è§£æ</span>
            <button id="close-analysis-btn" class="control-button" style="padding: 0;">
                <i data-lucide="x" class="w-4 h-4 text-gray-500 hover:text-red-500"></i>
            </button>
        </div>
        <div id="analysis-content" class="analysis-content">
            <p style="text-align: center; color: var(--text-light);">ç‚¹å‡»â€œæ­Œæ›²è§£æâ€æŒ‰é’®ï¼Œè·å–å½“å‰æ­Œæ›²çš„æ·±åº¦ä¿¡æ¯ã€‚</p>
        </div>
        <div id="analysis-sources" class="analysis-sources"></div>
    </div>

    <script>
        // =========================================================
        // GEMINI API é…ç½®å’Œå‡½æ•° (æ–°å¢)
        // =========================================================
        const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
        const API_KEY = ""; // Canvas will provide this at runtime

        async function exponentialBackoffFetch(url, options, maxRetries = 5) {
            for (let i = 0; i < maxRetries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.ok) {
                        return await response.json();
                    }
                    if (response.status === 429 || response.status >= 500) {
                        const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                        console.warn(`Request failed with status ${response.status}. Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    throw new Error(`API request failed with status ${response.status}: ${response.statusText}`);
                } catch (error) {
                    if (i === maxRetries - 1) throw error;
                    const delay = Math.pow(2, i) * 1000 + Math.random() * 1000;
                    console.warn(`Fetch error: ${error.message}. Retrying in ${delay / 1000}s...`);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        async function fetchSongAnalysis() {
            const currentTitle = currentTitleEl.textContent;
            const currentArtist = currentArtistEl.textContent;

            if (currentTitle === 'æœªé€‰æ‹©æ­Œæ›²') {
                displayAnalysis('<p>è¯·å…ˆé€‰æ‹©ä¸€é¦–æ­Œæ›²å¼€å§‹æ’­æ”¾ã€‚</p>', []);
                return;
            }

            const prompt = `è¯·ä½œä¸ºéŸ³ä¹è¯„è®ºå®¶å’Œæ–‡åŒ–å­¦è€…ï¼Œä¸ºæ­Œæ›²ã€Š${currentTitle}ã€‹ (æ¼”å”±/ä½œè€…: ${currentArtist}) å†™ä¸€æ®µç®€çŸ­çš„è§£æã€‚å†…å®¹åº”åŒ…å«ï¼šæ­Œæ›²çš„èƒŒæ™¯ã€ä¸»é¢˜æ€æƒ³ã€ä»¥åŠå¯¹æ­Œè¯çš„æ·±åº¦è§£è¯»ã€‚è¯·ç”¨ä¸­æ–‡å†™ä¸€æ®µç®€æ´çš„ã€çº¦150å­—å·¦å³çš„æ®µè½ã€‚`;
            
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: {
                    parts: [{ text: "ä½ æ˜¯ä¸€ä½å¯Œæœ‰æ´å¯ŸåŠ›çš„éŸ³ä¹è¯„è®ºå®¶ï¼Œæä¾›ç®€æ´ã€ä¼˜é›…çš„æ­Œæ›²èƒŒæ™¯å’Œæ­Œè¯æ·±åº¦è§£æï¼Œä¸“æ³¨äºæƒ…æ„Ÿå’Œä¸»é¢˜ã€‚" }]
                },
                tools: [{ "google_search": {} }],
            };

            displayAnalysis('<div class="spinner"></div>', []); // æ˜¾ç¤ºåŠ è½½åŠ¨ç”»
            const analyzeBtn = document.getElementById('analyze-btn');
            analyzeBtn.disabled = true;

            const url = `${API_URL}?key=${API_KEY}`;
            
            try {
                const result = await exponentialBackoffFetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const text = candidate.content.parts[0].text;
                    let sources = [];
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }
                    displayAnalysis(`<p>${text}</p>`, sources);
                } else {
                    displayAnalysis('<p>æŠ±æ­‰ï¼Œæœªèƒ½è·å–åˆ°æ­Œæ›²è§£æä¿¡æ¯ã€‚</p>', []);
                }
            } catch (error) {
                console.error("Gemini API Error:", error);
                displayAnalysis('<p>ç½‘ç»œè¯·æ±‚å¤±è´¥æˆ– API é”™è¯¯ã€‚è¯·ç¨åå†è¯•ã€‚</p>', []);
            } finally {
                analyzeBtn.disabled = false;
            }
        }

        function displayAnalysis(htmlContent, sources) {
            const panel = document.getElementById('analysis-panel');
            const content = document.getElementById('analysis-content');
            const sourceEl = document.getElementById('analysis-sources');

            content.innerHTML = htmlContent;
            
            if (sources.length > 0) {
                sourceEl.innerHTML = 'æ¥æºï¼š' + sources.map((s, i) => 
                    `<a href="${s.uri}" target="_blank">${s.title.substring(0, 50)}...</a>${i < sources.length - 1 ? ' | ' : ''}`
                ).join('');
            } else {
                sourceEl.innerHTML = '';
            }

            panel.style.display = 'flex'; // æ˜¾ç¤ºé¢æ¿
        }

        // ç¡®ä¿å›¾æ ‡åº“åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            initPlayer();
        });

        // =========================================================
        // æ¨¡æ‹Ÿæ•°æ®å’Œæ ¸å¿ƒé€»è¾‘
        // =========================================================

        const playlist = [
            { id: 1, title: 'æ™¨å…‰ä¹‹æ›²', artist: 'ä½œæ›²å®¶ A', duration: '3:45', src: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3', cover: 'https://placehold.co/500x500/1677ff/ffffff?text=A' },
            { id: 2, title: 'é™å¤œæ€', artist: 'æ­Œè€… B', duration: '4:12', src: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-2.mp3', cover: 'https://placehold.co/500x500/1677ff/ffffff?text=B' },
            { id: 3, title: 'å±±æ¶§æ¸…æµ', artist: 'æ¼”å¥å®¶ C', duration: '2:59', src: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-3.mp3', cover: 'https://placehold.co/500x500/1677ff/ffffff?text=C' },
            { id: 4, title: 'éƒ½å¸‚æ¼«æ­¥', artist: 'DJ D', duration: '3:30', src: 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-4.mp3', cover: 'https://placehold.co/500x500/1677ff/ffffff?text=D' },
        ];

        // æ¨¡æ‹Ÿæ­Œè¯æ•°æ®ï¼šæ—¶é—´ (ç§’) -> æ­Œè¯æ–‡æœ¬
        const mockLyrics = {
            1: [
                { time: 0, text: ' [00:00] æ¬¢è¿ä½¿ç”¨ Ant Design é£æ ¼æ’­æ”¾å™¨ï¼' },
                { time: 5, text: ' [00:05] è¿™æ˜¯ä¸€æ¬¾åŸºäº VuePress çš„æ’ä»¶ã€‚' },
                { time: 10, text: ' [00:10] æˆ‘ä»¬é‡æ–°è®¾è®¡äº† UIã€‚' },
                { time: 15, text: ' [00:15] é‡‡ç”¨çº¯ CSS æ¨¡æ‹Ÿ AntD æ•ˆæœã€‚' },
                { time: 20, text: ' [00:20] æ’­æ”¾åˆ—è¡¨å’Œæ­Œè¯åŠŸèƒ½é½å…¨ã€‚' },
                { time: 25, text: ' [00:25] æ„Ÿå—ä¸€ä¸‹ç®€æ´ã€ä¸“ä¸šçš„é£æ ¼ã€‚' },
                { time: 30, text: ' [00:30] æ­£åœ¨æ’­æ”¾ï¼šæ™¨å…‰ä¹‹æ›²ã€‚' },
            ],
            2: [
                { time: 0, text: ' [00:00] å¤œæ·±äº†ï¼Œæ¥ä¸€é¦–é™å¤œæ€ã€‚' },
                { time: 6, text: ' [00:06] ä½æ²‰çš„æ—‹å¾‹å¸¦æ¥å¹³é™ã€‚' },
                { time: 12, text: ' [00:12] è®©æˆ‘ä»¬æ”¾æ¾èº«å¿ƒï¼Œäº«å—æ­¤åˆ»ã€‚' },
                { time: 18, text: ' [00:18] æ­Œè€… B å¸¦æ¥çš„ç¾å¦™ä¹ç« ã€‚' },
                { time: 25, text: ' [00:25] æ²‰æµ¸åœ¨éŸ³ä¹çš„ä¸–ç•Œé‡Œã€‚' },
            ],
            3: [
                { time: 0, text: ' [00:00] å±±æ¶§æ¸…æµï¼Œæ½ºæ½ºæ°´å£°ã€‚' },
                { time: 8, text: ' [00:08] æ¼”å¥å®¶ C çŒ®ä¸Šçº¯å‡€çš„éŸ³ç¬¦ã€‚' },
                { time: 16, text: ' [00:16] èŠ‚å¥è½»å¿«ï¼Œå¿ƒæƒ…èˆ’ç•…ã€‚' },
            ],
            4: [
                { time: 0, text: ' [00:00] éƒ½å¸‚æ¼«æ­¥ï¼ŒèŠ‚å¥æ„Ÿåè¶³ã€‚' },
                { time: 4, text: ' [00:04] DJ D çš„åŠ¨æ„ŸèŠ‚æ‹ã€‚' },
                { time: 8, text: ' [00:08] å‡†å¤‡å¥½æ‘‡æ‘†äº†å—ï¼Ÿ' },
                { time: 12, text: ' [00:12] äº«å—è¿™åœºå¬è§‰ç››å®´ã€‚' },
            ],
        };

        let currentTrackIndex = 0;
        let isPlaying = false;
        let autoPlayAfterLoad = false; // æ–°å¢æ ‡å¿—ï¼Œç”¨äºæ§åˆ¶åŠ è½½å®Œæˆåæ˜¯å¦è‡ªåŠ¨æ’­æ”¾

        // =========================================================
        // DOM å…ƒç´ å¼•ç”¨
        // =========================================================
        const audio = document.getElementById('audio-player');
        const playlistContainer = document.getElementById('playlist-container');
        const playPauseBtn = document.getElementById('play-pause-btn');
        const playPauseIcon = document.getElementById('play-pause-icon');
        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const progressBar = document.getElementById('progress-bar');
        const volumeBar = document.getElementById('volume-bar');
        const currentTimeEl = document.getElementById('current-time');
        const totalTimeEl = document.getElementById('total-time');
        const currentTitleEl = document.getElementById('current-title');
        const currentArtistEl = document.getElementById('current-artist');
        const lyricsDisplay = document.getElementById('lyrics-display');
        const albumArtEl = document.querySelector('.album-art');
        const volumeIconEl = document.getElementById('volume-icon'); // éŸ³é‡å›¾æ ‡å¼•ç”¨
        const volumePercentEl = document.getElementById('volume-percent'); // éŸ³é‡ç™¾åˆ†æ¯”å¼•ç”¨
        const muteBtn = document.getElementById('mute-btn'); // æ–°å¢é™éŸ³æŒ‰é’®å¼•ç”¨
        const analyzeBtn = document.getElementById('analyze-btn'); // æ–°å¢è§£ææŒ‰é’®å¼•ç”¨
        const closeAnalysisBtn = document.getElementById('close-analysis-btn'); // æ–°å¢å…³é—­æŒ‰é’®å¼•ç”¨
        const analysisPanel = document.getElementById('analysis-panel'); // æ–°å¢è§£æé¢æ¿å¼•ç”¨
        
        let lastVolume = 0.75; // å­˜å‚¨é™éŸ³å‰çš„éŸ³é‡

        // =========================================================
        // æ ¼å¼åŒ–æ—¶é—´ (ç§’ -> åˆ†:ç§’)
        // =========================================================
        function formatTime(seconds) {
            const minutes = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
        }

        // =========================================================
        // æ¸²æŸ“æ’­æ”¾åˆ—è¡¨
        // =========================================================
        function renderPlaylist() {
            playlistContainer.innerHTML = playlist.map((track, index) => `
                <div 
                    class="track-item"
                    data-index="${index}"
                    data-id="${track.id}"
                >
                    <div class="track-info-main">
                        <span class="track-index">${index + 1}.</span>
                        <div class="track-titles">
                            <p class="track-title">${track.title}</p>
                            <p class="track-artist">${track.artist}</p>
                        </div>
                    </div>
                    <span class="track-duration">${track.duration}</span>
                </div>
            `).join('');

            // æ·»åŠ ç‚¹å‡»äº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('.track-item').forEach(item => {
                item.addEventListener('click', (e) => {
                    const index = parseInt(e.currentTarget.getAttribute('data-index'));
                    
                    if (index === currentTrackIndex && audio.src) {
                         // å¦‚æœç‚¹å‡»çš„æ˜¯å½“å‰æ­Œæ›²ï¼Œåˆ™åˆ‡æ¢æ’­æ”¾/æš‚åœçŠ¶æ€
                         togglePlayPause();
                    } else {
                        // å¦‚æœæ˜¯æ–°æ­Œæ›²ï¼ŒåŠ è½½å¹¶è¯·æ±‚è‡ªåŠ¨æ’­æ”¾
                        loadTrack(index, true); 
                    }
                });
            });

            updatePlaylistHighlight();
        }

        // =========================================================
        // æ›´æ–°æ’­æ”¾åˆ—è¡¨é«˜äº®çŠ¶æ€
        // =========================================================
        function updatePlaylistHighlight() {
            document.querySelectorAll('.track-item').forEach((item, index) => {
                item.classList.remove('is-playing');
                
                if (index === currentTrackIndex) {
                    item.classList.add('is-playing');
                    // æ»šåŠ¨åˆ°å½“å‰æ’­æ”¾æ­Œæ›²
                    item.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            });
        }

        // =========================================================
        // åŠ è½½æ­Œæ›²
        // =========================================================
        function loadTrack(index, autoPlay = false) { // å¢åŠ  autoPlay å‚æ•°
            currentTrackIndex = index;
            const track = playlist[currentTrackIndex];
            audio.src = track.src;
            audio.load(); // é‡æ–°åŠ è½½éŸ³é¢‘

            // è®¾ç½®è‡ªåŠ¨æ’­æ”¾æ ‡å¿—ï¼Œå°†åœ¨ loadeddata äº‹ä»¶ä¸­æ£€æŸ¥
            autoPlayAfterLoad = autoPlay;
            
            // æ›´æ–° UI ä¿¡æ¯
            currentTitleEl.textContent = track.title;
            currentArtistEl.textContent = track.artist;
            albumArtEl.style.backgroundImage = `url('${track.cover}')`;
            
            // é‡ç½®è¿›åº¦æ¡å’Œæ—¶é—´æ˜¾ç¤º
            progressBar.value = 0;
            currentTimeEl.textContent = '0:00';
            totalTimeEl.textContent = track.duration; // åˆå§‹æ˜¾ç¤ºé¢„è®¾æ—¶é•¿
            
            updatePlaylistHighlight();
            renderLyrics(track.id);
            // æ¯æ¬¡åˆ‡æ¢æ­Œæ›²æ—¶ï¼Œå…³é—­è§£æé¢æ¿
            analysisPanel.style.display = 'none';
        }

        // =========================================================
        // æ’­æ”¾/æš‚åœæ§åˆ¶
        // =========================================================
        function playTrack() {
            if (audio.paused) {
                // ç¡®ä¿ play() è°ƒç”¨è¢« catch å¤„ç†ï¼Œé˜²æ­¢æœªå¤„ç†çš„ promise æ‹’ç»
                audio.play().catch(e => console.error("æ’­æ”¾å¤±è´¥:", e));
                isPlaying = true;
                playPauseIcon.setAttribute('data-lucide', 'pause');
            }
        }

        function pauseTrack() {
            audio.pause();
            isPlaying = false;
            playPauseIcon.setAttribute('data-lucide', 'play');
        }

        function togglePlayPause() {
            if (audio.src) { // ç¡®ä¿æœ‰æ­Œæ›²åŠ è½½
                if (isPlaying) {
                    pauseTrack();
                } else {
                    playTrack();
                }
                // é‡æ–°æ¸²æŸ“ Lucide Icon
                lucide.createIcons(); 
            } else {
                // å¦‚æœæ²¡æœ‰æ­Œæ›²ï¼Œåˆ™åŠ è½½ç¬¬ä¸€é¦–å¹¶æ’­æ”¾
                if (playlist.length > 0) {
                    loadTrack(0, true); // è¯·æ±‚åŠ è½½åè‡ªåŠ¨æ’­æ”¾
                }
            }
        }
        
        // =========================================================
        // åˆ‡æ¢æ­Œæ›²
        // =========================================================
        function nextTrack() {
            const nextIndex = (currentTrackIndex + 1) % playlist.length;
            loadTrack(nextIndex, true); // è¯·æ±‚åŠ è½½åè‡ªåŠ¨æ’­æ”¾
        }

        function prevTrack() {
            const prevIndex = (currentTrackIndex - 1 + playlist.length) % playlist.length;
            loadTrack(prevIndex, true); // è¯·æ±‚åŠ è½½åè‡ªåŠ¨æ’­æ”¾
        }

        // =========================================================
        // æ¸²æŸ“æ­Œè¯
        // =========================================================
        function renderLyrics(trackId) {
            const lyrics = mockLyrics[trackId] || [{ time: 0, text: ' [00:00] æš‚æ— æ­Œè¯ã€‚' }];
            lyricsDisplay.innerHTML = lyrics.map((line, index) => `
                <p 
                    class="lyric-line" 
                    data-time="${line.time}"
                    data-index="${index}"
                >
                    ${line.text}
                </p>
            `).join('');
            
            // ç¡®ä¿æ­Œè¯åŒºåŸŸæ»šåŠ¨åˆ°é¡¶éƒ¨
            lyricsDisplay.parentNode.scrollTop = 0;
        }

        // =========================================================
        // æ›´æ–° UI çŠ¶æ€å’Œæ­Œè¯åŒæ­¥
        // =========================================================
        let lastLyricIndex = -1;
        function updateUI() {
            // 1. æ›´æ–°è¿›åº¦æ¡å’Œæ—¶é—´
            if (!isNaN(audio.duration)) {
                const percentage = (audio.currentTime / audio.duration) * 100;
                // æ³¨æ„ï¼šç”±äºæˆ‘ä»¬ä½¿ç”¨çš„æ˜¯çº¯ CSS æ ·å¼ï¼Œéœ€è¦ç”¨ JS æ¥åŠ¨æ€è®¾ç½®è¿›åº¦æ¡é¢œè‰²
                const primaryColor = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim();
                progressBar.style.background = `linear-gradient(to right, ${primaryColor} 0%, ${primaryColor} ${percentage}%, var(--border-color) ${percentage}%, var(--border-color) 100%)`;
                
                progressBar.value = audio.currentTime; // è¿›åº¦æ¡ç›´æ¥ç»‘å®š currentTimeï¼Œmax åœ¨ loadedmetadata æ—¶è®¾ç½®
                currentTimeEl.textContent = formatTime(audio.currentTime);

                if (totalTimeEl.textContent === '0:00' && !isNaN(audio.duration)) {
                    totalTimeEl.textContent = formatTime(audio.duration);
                }
            }

            // 2. æ­Œè¯åŒæ­¥
            const currentTime = audio.currentTime;
            const trackId = playlist[currentTrackIndex].id;
            const lyrics = mockLyrics[trackId] || [];
            
            let currentLyricIndex = -1;
            for (let i = 0; i < lyrics.length; i++) {
                if (currentTime >= lyrics[i].time) {
                    currentLyricIndex = i;
                } else {
                    break;
                }
            }

            if (currentLyricIndex !== lastLyricIndex && currentLyricIndex !== -1) {
                // ç§»é™¤æ—§çš„é«˜äº®
                const oldLyricEl = document.querySelector(`.current-lyric`);
                if (oldLyricEl) {
                    oldLyricEl.classList.remove('current-lyric');
                }

                // æ·»åŠ æ–°çš„é«˜äº®
                const newLyricEl = document.querySelector(`.lyric-line[data-index="${currentLyricIndex}"]`);
                if (newLyricEl) {
                    newLyricEl.classList.add('current-lyric');
                    
                    // æ­Œè¯æ»šåŠ¨ï¼šç¡®ä¿å½“å‰æ­Œè¯ä½äºæ˜¾ç¤ºåŒºåŸŸä¸­é—´
                    const lyricContainer = lyricsDisplay.parentNode;
                    const offset = newLyricEl.offsetTop - lyricContainer.clientHeight / 2 + newLyricEl.clientHeight / 2;
                    lyricContainer.scrollTop = offset;
                }

                lastLyricIndex = currentLyricIndex;
            }
        }
        
        // =========================================================
        // åˆ‡æ¢é™éŸ³
        // =========================================================
        function toggleMute() {
            if (audio.muted) {
                // å–æ¶ˆé™éŸ³ï¼Œæ¢å¤åˆ°ä¸Šæ¬¡çš„éŸ³é‡
                audio.muted = false;
                audio.volume = lastVolume > 0 ? lastVolume : 0.75; // ç¡®ä¿ä¸ä¸º 0
            } else {
                // é™éŸ³ï¼Œå¹¶ä¿å­˜å½“å‰éŸ³é‡
                lastVolume = audio.volume;
                audio.muted = true;
            }
            updateVolumeUI(audio.volume);
        }
        
        // =========================================================
        // æ›´æ–°éŸ³é‡ UI
        // =========================================================
        function updateVolumeUI(volume) {
            // 1. æ›´æ–°éŸ³é‡å›¾æ ‡
            let iconName;
            if (audio.muted || volume === 0) {
                iconName = 'volume-x';
            } else if (volume < 0.5) {
                iconName = 'volume-1';
            } else {
                iconName = 'volume-2';
            }
            volumeIconEl.setAttribute('data-lucide', iconName);
            lucide.createIcons();

            // 2. æ›´æ–°éŸ³é‡ç™¾åˆ†æ¯”æ˜¾ç¤º
            if (audio.muted) {
                volumePercentEl.textContent = `MUTE`; 
            } else {
                volumePercentEl.textContent = `${Math.round(volume * 100)}%`;
            }
            
            // 3. æ›´æ–°æ»‘å—ä½ç½®ï¼ˆå½“éé™éŸ³æ—¶ï¼Œæ»‘å—åº”åæ˜ å®é™…éŸ³é‡ï¼›é™éŸ³æ—¶æ»‘å—ä¿æŒåœ¨é™éŸ³å‰çš„ä½ç½®ï¼‰
            if (!audio.muted) {
                volumeBar.value = volume;
            }
            // æç¤ºï¼šå¦‚æœå¸Œæœ›é™éŸ³æ—¶æ»‘å—ç§»åˆ° 0ï¼Œå¯ä»¥å°†è¿™è¡Œç§»åˆ° if å—å¤–é¢
        }


        // =========================================================
        // åˆå§‹åŒ–æ’­æ”¾å™¨
        // =========================================================
        function initPlayer() {
            // 1. æ¸²æŸ“åˆ—è¡¨
            renderPlaylist();
            
            // 2. è®¾ç½®åˆå§‹éŸ³é‡
            audio.volume = lastVolume;
            volumeBar.value = audio.volume; // åˆå§‹åŒ–æ»‘å—å€¼
            updateVolumeUI(audio.volume); // åˆå§‹åŒ–éŸ³é‡UI

            // 3. åŠ è½½ç¬¬ä¸€é¦–æ­Œï¼ˆä¸è‡ªåŠ¨æ’­æ”¾ï¼‰
            if (playlist.length > 0) {
                loadTrack(0);
            }

            // 4. äº‹ä»¶ç›‘å¬å™¨
            playPauseBtn.addEventListener('click', togglePlayPause);
            nextBtn.addEventListener('click', nextTrack);
            prevBtn.addEventListener('click', prevTrack);
            muteBtn.addEventListener('click', toggleMute); // æ–°å¢é™éŸ³æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            analyzeBtn.addEventListener('click', fetchSongAnalysis); // æ–°å¢è§£ææŒ‰é’®äº‹ä»¶
            closeAnalysisBtn.addEventListener('click', () => analysisPanel.style.display = 'none'); // å…³é—­é¢æ¿äº‹ä»¶
            
            // è¿›åº¦æ¡æ‹–åŠ¨
            progressBar.addEventListener('input', (e) => {
                // å®æ—¶æ›´æ–°æ—¶é—´æ ‡ç­¾
                currentTimeEl.textContent = formatTime(e.target.value);
            });

            progressBar.addEventListener('change', (e) => {
                const seekTime = parseFloat(e.target.value);
                audio.currentTime = seekTime;
            });
            
            // éŸ³é‡æ§åˆ¶
            volumeBar.addEventListener('input', (e) => {
                const newVolume = parseFloat(e.target.value);
                
                // å¦‚æœç”¨æˆ·é€šè¿‡æ»‘å—è°ƒæ•´äº†éŸ³é‡ï¼ˆä¸”éŸ³é‡å¤§äº0ï¼‰ï¼Œåˆ™å–æ¶ˆé™éŸ³çŠ¶æ€
                if (audio.muted && newVolume > 0) {
                    audio.muted = false;
                }
                
                audio.volume = newVolume;
                lastVolume = newVolume; // æ›´æ–° lastVolume
                updateVolumeUI(newVolume); // å®æ—¶æ›´æ–°éŸ³é‡ UI
            });

            // ç›‘å¬ audio å¯¹è±¡çš„ volumechange äº‹ä»¶ï¼Œå¤„ç†å¤–éƒ¨ï¼ˆå¦‚ç³»ç»Ÿï¼‰éŸ³é‡å˜åŒ–æˆ–é™éŸ³çŠ¶æ€æ”¹å˜
            audio.addEventListener('volumechange', () => {
                updateVolumeUI(audio.volume);
            });


            // å…¶ä»–éŸ³é¢‘äº‹ä»¶
            audio.addEventListener('timeupdate', updateUI);
            audio.addEventListener('ended', nextTrack);
            audio.addEventListener('loadeddata', () => {
                // åœ¨å…ƒæ•°æ®åŠ è½½åè·å–å‡†ç¡®çš„æ€»æ—¶é•¿
                if (!isNaN(audio.duration)) {
                    totalTimeEl.textContent = formatTime(audio.duration);
                    progressBar.setAttribute('max', audio.duration);
                    progressBar.value = audio.currentTime;
                }

                // å¦‚æœè®¾ç½®äº†è‡ªåŠ¨æ’­æ”¾æ ‡å¿—ï¼Œåˆ™åœ¨æ•°æ®åŠ è½½å®Œæˆåå¼€å§‹æ’­æ”¾
                if (autoPlayAfterLoad && audio.paused) {
                    playTrack();
                    autoPlayAfterLoad = false; // é‡ç½®æ ‡å¿—ï¼Œé˜²æ­¢é‡å¤æ’­æ”¾
                }
            });
            audio.addEventListener('play', () => {
                isPlaying = true;
                playPauseIcon.setAttribute('data-lucide', 'pause');
                lucide.createIcons();
            });
            audio.addEventListener('pause', () => {
                isPlaying = false;
                playPauseIcon.setAttribute('data-lucide', 'play');
                lucide.createIcons();
            });
        }
    </script>
</body>
</html>